<tool id="SRS_canopy_indices" name="Compute spectral indices" version="@VERSION@" profile = "20.01">
    <description>as NDVI from remote sensing data</description>
    <macros>
        <import>macro.xml</import>
    </macros>
    <requirements>
        <requirement type="package" version="2.11.0">r-R.utils</requirement>
        <requirement type="package" version="3.5_15">r-raster</requirement>
        <requirement type="package" version="1.4_7">r-sp</requirement>
        <requirement type="package" version="1.5_29">r-rgdal</requirement>
        <requirement type="package" version="0.2_5.2">r-rasterdiv</requirement>
        <requirement type="package" version="0.5_5">r-stars</requirement>
        <requirement type="package" version="1.4.0">r-stringr</requirement>
        <requirement type="package" version="2.3.8">r-pracma</requirement> 
        <requirement type="package" version="0.1_7">r-expint</requirement> 
        <requirement type="package" version="0.62.0">r-matrixStats</requirement> 
        <requirement type="package" version="3.3.6">r-ggplot2</requirement>
        <requirement type="package" version="3.99_0.9">r-xml</requirement>  
    </requirements>
    <command detect_errors="exit_code"><![CDATA[ 
        #if $method.type == 'envi_bil': 
          cp '$input_raster' '${input_raster.element_identifier}' &&
          cp '$input_header' '${input_header.element_identifier}' &&
        #end if 
        Rscript
            '$__tool_directory__/indices_canopy.r'
             #if $method.type == 'envi_bil':
              '$method.input_raster.element_identifier'
              '$method.input_header.element_identifier'
              ''
            #else:
              ''
              ''
              '$method.input'
            #end if
            '$__tool_directory__/prosail-master/R/Lib_PROSAIL.R'
            '$__tool_directory__/prosail-master/R/Lib_SpectralIndices.R'
            '$__tool_directory__/prosail-master/R/Lib_PROSAIL_HybridInversion.R'
            '$input_indice'
            '$__tool_directory__/functions.r'
            '$output_indices'
        ]]>
    </command>
    <inputs>
        <conditional name="method">
            <param name="type" type="select" label="Which kind of data ?">
                <option value="zipper">The data you are using are in a zip folder Reflectance</option>
                <option value="envi_bil">Your already have the files ENVI BIL</option>
            </param>
            <when value="zipper">
                <param name="input" type="data" format="data" multiple="true" label="Input data"/>
            </when>
            <when value="envi_bil">
                <param name="input_raster" type="data" format="bil" label="Input raster"/>
                <param name="input_header" type="data" format="hdr" label="Input raster header"/>
            </when>
        </conditional>
        <param name="input_indice" type="select" label="Input the type of indice you want">
            <option value="ARI1">ARI1</option>
            <option value="ARI2">ARI2</option>
            <option value="ARVI">ARVI</option>
            <option value="BAI">BAI</option>
            <option value="BAIS2">BAIS2</option>
            <option value="CHL_RE">CHL RE</option>
            <option value="CRI1">CRI1</option>
            <option value="CRI2">CRI2</option>
            <option value="EVI">EVI</option>
            <option value="EVI2">EVI2</option>
            <option value="GRVI1">GRVI1</option>
            <option value="GNDVI">GNDVI</option>
            <option value="IRECI">IRECI</option>
            <option value="LAI_SAVI">LAI SAVI</option>
            <option value="MCARI">MCARI</option>
            <option value="mNDVI705">mNDVI705</option>
            <option value="MSAVI2">MSAVI2</option>
            <option value="MSI">MSI</option>
            <option value="mSR705">mSR705</option>
            <option value="MTCI">MTCI</option>
            <option value="nBR_RAW">nBR_RAW</option>
            <option value="NDI_45">NDI_45</option>
            <option value="NDII">NDII</option>
            <option value="NDVI">NDVI</option>
            <option value="NDVI_G">NDVI_G</option>
            <option value="NDVI705">NDVI705</option>
            <option value="NDWI1">NDWI1</option>
            <option value="NDWI2">NDWI2</option>
            <option value="PSRI">PSRI</option>
            <option value="PSRI_NIR">PSRI_NIR</option>
            <option value="RE_NDVI">RE_NDVI</option>
            <option value="RE_NDWI">RE_NDWI</option>
            <option value="S2REP">S2REP</option>
            <option value="SAVI">SAVI</option>
            <option value="SIPI">SIPI</option>
            <option value="SR">SR</option>
            <option value="CR_SWIR">CR_SWIR</option>
        </param>
    </inputs>
    <outputs>
        <data name="output_indices" from_work_dir="Spec_Index.tabular" format="tabular" label="${input_indice}">
        </data>
        <collection type="list" name="plots">
            <discover_datasets pattern="(?P&lt;designation&gt;.+)\.png" visible="false" format="png"/>
        </collection>
    </outputs>
    <tests>
        <test>
            <param name="input_raster" value="S2A_Subset"/>
            <param name="input_header" value="S2A_Subset.hdr"/>
            <param name="input_indice" value="ARI1"/>
            <output name="output_indices" value="ARI1.tabular"/>
            <output_collection name="plots" type="list" count="1"/>
        </test>
    </tests>
    <help><![CDATA[
=========================================================================
Computes biodiversity spectral indices from satellite remote sensing data 
=========================================================================


**What it does**

This tool includes inversion routines based on iterative optimization and hybrid method in order to estimate vegetation properties (leaf and canopy) from sensor measurements.

**Input description**

It expects an image file as input, with a specific data format. ENVI HDR image with BIL interleave required.
The image is an ENVI raster including :

- A binary file (which has no extension here).

- A header file (with .hdr extension).

The header file is a text file including all necessary metadata which can be read with a text editor. It includes image dimensions, projection, and the name and central wavelength for each spectral band.

In order to get such input we advise to use the tool preprocessing sentinel 2 data. 

+--------------+----------+---------------+
|      BIL     | ENVI HDR |Spectral indice|
+==============+==========+===============+
| raster stack | Metadata |     NDVI      |
+--------------+----------+---------------+
|      ...     |    ...   |      ...      |
+--------------+----------+---------------+

**Output**

One tabular with 3 columns : longitude, latitude and the chosen indice. 

One png plot for the vizualisation of the chosen indice.

    ]]>    </help>
        <expand macro="SRS_prosailref"/>
</tool>
